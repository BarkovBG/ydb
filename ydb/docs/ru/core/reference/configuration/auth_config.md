# Секция `auth_config`

{{ ydb-short-name }} позволяет использовать различные способы аутентификации пользователя в системе. Настройки аутентификации и провайдеров аутентификации задаются в секции `auth_config` файла конфигурации {{ ydb-short-name }}.

## Конфигурация аутентификации внутренних пользователей {{ ydb-short-name }} {#local-auth-config}

Внутренние пользователи {{ ydb-short-name }} добавляются непосредственно в базу данных {{ ydb-short-name }} без использования сторонних служб каталогов. Подробнее о таком виде аутентификации написано в разделе про [аутентификацию по логину и паролю](../../security/authentication.md#static-credentials). Для конфигурирования аутентификации внутренних пользователей по логину и паролю необходимо описать следующие параметры в секции `auth_config`.

#|
|| Параметр | Описание ||
|| use_login_provider
| Флаг определяет возможность аутентификации внутренних пользователей по auth-токенам, выдаваемым {{ ydb-short-name }} при входе с логином и паролем.

Значение по умолчанию: `true`
    ||
|| enable_login_authentication
| Флаг определяет возможность создания внутренних пользователей и выдачи им auth-токенов при входе с логином и паролем в {{ ydb-short-name }}.

Значение по умолчанию: `true`
    ||
|| domain_login_only
| Флаг определяет базы данных, в которые добавляются внутренние пользователи.

Валидные значения:

- `true` – внутренние пользователи добавляются только в корневую базу данных кластера;
- `false` – внутренние пользователи добавляются в корневую и/или тенантные базы данных кластера.

Значение по умолчанию: `true`
    ||
|| login_token_expire_time
| Время жизни auth-токена при логине внутреннего пользователя.

Значение по умолчанию: `12h`
    ||
|#

### Конфигурация блокировки пользователя при неправильно введённом пароле {#account-lockout}

{{ ydb-short-name }} позволяет запретить пользователю аутентифицироваться, если он сделал несколько неудачных попыток ввести правильный пароль. Для конфигурирования условий блокирования пользователя необходимо заполнить секцию `account_lockout`.

Пример секции `account_lockout`:

```yaml
auth_config:
  ...
  account_lockout:
    attempt_threshold: 4
    attempt_reset_duration: "1h"
  ...
```

#|
|| Параметр | Описание ||
|| attempt_threshold
| Количество неправильных попыток введения пароля, после которых учётная запись пользователя временно блокируется. Если пользователь ввёл указанное количество раз подряд неправильный пароль, то ему запрещается аутентифицироваться на время, заданное в параметре `attempt_reset_duration`.

Если параметр имеет значение `0`, то число попыток ввода неправильного пароля не ограничено.

Значение по умолчанию: `4`
    ||
|| attempt_reset_duration
| Период времени, в течение которого пользователь считается заблокированным. Заблокированному пользователю запрещено выполнять аутентификацию. Период блокировки начинается с момента последней неверной попытки ввода пароля.

Если указано значение эквивалентное `"0s"`, то пользователь будет заблокирован неограниченное время.

Значение по умолчанию: `1h`
    ||
|#

### Конфигурация требований к сложности пароля {#password-complexity}

{{ ydb-short-name }} позволяет аутентифицировать пользователей по логину и паролю. Подробнее можно прочитать в разделе [аутентификация по логину и паролю](../../security/authentication.md#static-credentials). Для повышения безопасности в {{ ydb-short-name }} имеется возможность настроить сложность используемых паролей пользователей. Для конфигурирования требований к паролю необходимо описать секцию `password_complexity`.

Пример секции `password_complexity`:

```yaml
auth_config:
  ...
  password_complexity:
    min_length: 8
    min_lower_case_count: 1
    min_upper_case_count: 1
    min_numbers_count: 1
    min_special_chars_count: 1
    special_chars: "!@#$%^&*()_+{}|<>?="
    can_contain_username: false
  ...
```

#|
|| Параметр | Описание ||
|| min_length
| Минимальный размер пароля.

Значение по умолчанию: 0 (не ограничено)
    ||
|| min_lower_case_count
| Минимальное количество строчных букв в пароле.

Значение по умолчанию: 0 (не ограничено)
    ||
|| min_upper_case_count
| Минимальное количество прописных букв в пароле.

Значение по умолчанию: 0 (не ограничено)
    ||
|| min_numbers_count
| Минимальное количество цифр в пароле.

Значение по умолчанию: 0 (не ограничено)
    ||
|| min_special_chars_count
| Минимальное количество специальных символов в пароле, из указанных в параметре `special_chars`.

Значение по умолчанию: 0 (не ограничено)
    ||
|| special_chars
| Перечень специальных символов допустимых при задании пароля.

Валидные значения: `!@#$%^&*()_+{}\|<>?=`

Значение по умолчанию: пустая строка (допускает использование всех валидных специальных символов)
    ||
|| can_contain_username
| Флаг определяет допустимость включения имени пользователя в пароль.

Значение по умолчанию: `false`
    ||
|#

## Конфигурация аутентификации с использованием стороннего IAM-провайдера {#iam-auth-config}

{{ ydb-short-name }} поддерживает аутентификацию пользователей с использованием сервиса Yandex Identity and Access Management (IAM), который используется в Yandex Cloud. Для конфигурирования IAM-аутентификации необходимо определить следующие параметры:

#|
|| Параметр | Описание ||
|| use_access_service
| Флаг определяет возможность аутентификации пользователей с использованием каталога IAM AccessService.

Значение по умолчанию: `false`
    ||
|| access_service_endpoint
| Адрес, по которому отправляются запросы в IAM AccessService.

Значение по умолчанию: `as.private-api.cloud.yandex.net:4286`
    ||
|| user_account_service_endpoint
| Адрес, по которому отправляются запросы в каталогу пользователей IAM AccessService.

Значение по умолчанию: `api-adapter.private-api.cloud.yandex.net:8443`
    ||
|| service_account_service_endpoint
| Адрес, по которому отправляются запросы в каталогу сервисных аккаунтов IAM AccessService.

Значение по умолчанию: `api-adapter.private-api.cloud.yandex.net:8443`
    ||
|| use_access_service_tls
| Флаг включает использование TLS-соединений между {{ ydb-short-name }} и IAM AccessService сервером.

Значение по умолчанию: `true`
    ||
|| access_service_domain
| Идентификатор, прикрепляемый к имени пользователя, позволяющий отличать пользователей из AccessService каталога от пользователей аутентифицируемых с помощью других провайдеров.

Значение по умолчанию: `as`
    ||
|| path_to_root_ca
| Путь до файла сертификата удостоверяющего центра, используемого для взаимодействия с AccessService.

Значение по умолчанию: `/etc/ssl/certs/YandexInternalRootCA.pem`
    ||
|| access_service_grpc_keep_alive_time_ms
| Период времени, в миллисекундах, по истечении которого {{ ydb-short-name }} посылает keepalive ping IAM-серверу, чтобы сохранить соединение.

Значение по умолчанию: `10000`
    ||
|| access_service_grpc_keep_alive_timeout_ms
| Период времени ожидания ответа от IAM-сервера на keepalive ping, в миллисекундах. Если по истечении срока ожидания ответ от IAM-сервера не приходит, {{ ydb-short-name }} закрывает соединение.

Значение по умолчанию: `1000`
    ||
|| use_access_service_api_key
| Использовать API-ключ. API-ключ — это секретный ключ, используемый для упрощённой авторизации сервисных аккаунтов в API Yandex Cloud. Его применяют, если нет возможности автоматически запрашивать IAM-токен.

Значение по умолчанию: `false`
    ||
|#

## Конфигурация LDAP аутентификации {#ldap-auth-config}

Одним из способов аутентификации пользователей в {{ ydb-short-name }} является использование LDAP каталога. Подробнее о таком виде аутентификации написано в разделе про [использование LDAP каталога](../../security/authentication.md#ldap). Для конфигурирования LDAP аутентификации необходимо описать секцию `ldap_authentication`.

Пример секции `ldap_authentication`:

```yaml
auth_config:
  ...
  ldap_authentication:
    hosts:
      - "ldap-hostname-01.example.net"
      - "ldap-hostname-02.example.net"
      - "ldap-hostname-03.example.net"
    port: 389
    base_dn: "dc=mycompany,dc=net"
    bind_dn: "cn=serviceAccaunt,dc=mycompany,dc=net"
    bind_password: "serviceAccauntPassword"
    search_filter: "uid=$username"
    use_tls:
      enable: true
      ca_cert_file: "/path/to/ca.pem"
      cert_require: DEMAND
  ldap_authentication_domain: "ldap"
  scheme: "ldap"
  requested_group_attribute: "memberOf"
  extended_settings:
      enable_nested_groups_search: true

  refresh_time: "1h"
  ...
```

Параметр | Описание
--- | ---
`hosts` | Список имен хостов, на котором работает LDAP сервер
`port` | Порт для подключения к LDAP серверу
`base_dn` | Корень поддерева в LDAP каталоге, начиная с которого будет производиться поиск записи пользователя
`bind_dn` | Отличительное имя (Distinguished Name, DN) сервисного аккаунта, от имени которого выполняется поиск записи пользователя
`bind_password` | Пароль сервисного аккаунта, от имени которого выполняется поиск записи пользователя
`search_filter` | Фильтр для поиска записи пользователя в LDAP каталоге. В строке фильтра может встречаться последовательность символов *$username*, которая будет заменена на имя пользователя, запрошенное для аутентификации в базе данных
`use_tls` | Настройки для конфигурирования TLS соединения между {{ ydb-short-name }} и LDAP сервером
`enable` | Определяет, будет ли произведена попытка установить TLS-соединение с [использованием запроса `StartTls`](../../security/authentication.md#starttls). При установке значения этого параметра в `true`, необходимо отключить использование схемы соединения `ldaps`, присвоив параметру `ldap_authentication.scheme` значение `ldap`.
`ca_cert_file` | Путь до файла сертификата удостоверяющего центра
`cert_require` | Уровень требований к сертификату LDAP сервера.<br/>Возможные значения:<ul><li>`NEVER` - {{ ydb-short-name }} не запрашивает сертификат или проверку проходит любой сертификат.</li><li>`ALLOW` - {{ ydb-short-name }} требует, что бы LDAP сервер предоставил сертификат. Если предоставленному сертификату нельзя доверять, TLS сессия все равно установится.</li><li>`TRY` - {{ ydb-short-name }} требует, что бы LDAP сервер предоставил сертификат. Если предоставленному сертификату нельзя доверять, установление TLS соединения прекращается.</li><li>`DEMAND` и `HARD` - Эти требования эквивалентны параметру `TRY`. По умолчанию установлено значение `DEMAND`.</li></ul>
`ldap_authentication_domain` | Идентификатор, прикрепляемый к имени пользователя, позволяющий отличать пользователей из LDAP каталога от пользователей аутентифицируемых с помощью других провайдеров. Значение по умолчанию `ldap`
`scheme` | Схема соединения с LDAP-сервером.<br>Возможные значения:<ul><li>`ldap` — {{ ydb-short-name }} будет выполнять соединение с LDAP-сервером без какого-либо шифрования. Пароли будут отправляться на LDAP-сервер в открытом виде. Это значение установлено по умолчанию.</li><li>`ldaps` — {{ ydb-short-name }} будет выполнять зашифрованное соединение с LDAP-сервером по протоколу TLS с самого первого запроса. Для успешного установления соединения по схеме `ldaps` необходимо отключить использование [запроса `StartTls`](../../security/authentication.md#starttls) в секции `ldap_authentication.use_tls.enable: false` и заполнить информацию о сертификате `ldap_authentication.use_tls.ca_cert_file` и уровне требования сертификата `ldap_authentication.use_tls.cert_require`.</li><li>При использовании любого другого значения будет браться значение по умолчанию - `ldap`.</li></ul>
`requested_group_attribute` | Атрибут обратного членства в группе. По умолчанию `memberOf`.
`extended_settings.enable_nested_groups_search` | Флаг определяет, будет ли выполнятся запрос для получения всего дерева групп, в которые входят непосредственные группы пользователя.
`host` | Имя хоста, на котором работает LDAP-сервер. Это устаревший параметр, вместо него должен использоваться параметр `hosts`.

## Настройки времени жизни токенов

Настройки времени жизни токена применимы ко всем методам аутентификации.

#|
|| refresh_period
| Определяет частоту проверки токенов пользователей на устаревание

Значение по умолчанию: `1s`
    ||
|| refresh_time
| Определяет время, когда будет попытка обновить информацию о пользователе. Конкретное время обновления будет лежать в интервале от `refresh_time/2` до `refresh_time`

Значение по умолчанию: `1h`
    ||
|| life_time
| Период хранения токена в кэше с момента его использования

Значение по умолчанию: `1h`
    ||
|| expire_time
| Период истечения срока действия токена, после которого токен удаляется из кэша

Значение по умолчанию: `24h`
    ||
|| min_error_refresh_time
| Минимальный период, после которого повторяется попытка обновить токен, при получении которого уже происходила ошибка

Значение по умолчанию: `1s`
    ||
|| max_error_refresh_time
| Максимальный период, до истечения которого повторяется попытка обновить токен, при получении которого происходила ошибка

Значение по умолчанию: `1m`
    ||
|#
